# Chkin — Handoff Summary

## Session Summary (Last Updated: 2025-12-25, Session 18)

### What Was Accomplished (This Session)

**1. Added Patient Type Column to Provider Submissions**

Added "Type" column showing whether a patient was Anonymous or Registered when they submitted the form, with filtering capability.

**Changes:**
- Added `PatientTypeBadge` component with three states:
  - Registered (teal) - user was logged in when submitting
  - Converted (emerald) - anonymous user who later registered (uses `claimedAt` field)
  - Anonymous (gray) - not yet converted
- Added filter dropdown for patient type
- Updated API to support `patientType` filter parameter
- Added `claimedAt` to API responses for conversion tracking

**Files Modified:**
```
app/src/app/(provider)/provider/submissions/page.tsx     # Added Type column, badge, filter
app/src/app/api/provider/submissions/route.ts            # Added patientType filter, claimedAt
app/src/app/api/provider/submissions/[id]/route.ts       # Added claimedAt to detail
```

**2. Fixed PDF Signing Not Saving for Existing Forms**

When editing an existing form to add DocuSeal PDF signing, changes weren't being saved because the "Save Changes" button remained disabled.

**Root Cause:** The `hasChanges` detection in the form edit page only tracked basic fields (title, description, consent clause, status, and form fields). It didn't include:
- PDF settings (pdfEnabled, docusealTemplateId, pdfFieldMappings)
- Consent configuration settings

**Fix:** Updated the `hasChanges` useEffect to include all settings:
- Added `hasPdfChanges` check for PDF settings
- Added `hasConsentConfigChanges` check for consent duration settings
- Updated dependency array to include all relevant state variables

**Files Modified:**
```
app/src/app/(provider)/provider/forms/[id]/page.tsx      # Fixed hasChanges detection
```

**3. Fixed Authenticated Users Treated as Anonymous After PDF Signing**

When authenticated users signed a PDF document and were redirected back from DocuSeal, they were incorrectly shown the "Create an Account" prompt instead of the success page.

**Root Cause:** The patient callback was redirecting authenticated users to `/c/[shortCode]?signed=true` (the public form page), which then did an auth check that may have failed silently due to cross-site cookie issues after external redirects.

**Fix:**
1. Updated patient DocuSeal callback to redirect authenticated users directly to `/patient/submissions?signed=true` instead of going through the public form page
2. Added success/error message handling to the patient submissions page
3. Wrapped submissions page with Suspense for useSearchParams compatibility

**Files Modified:**
```
app/src/app/api/patient/submissions/[id]/docuseal/callback/route.ts  # Redirect to patient portal
app/src/app/(patient)/patient/submissions/page.tsx                    # Added success message display
```

---

### Previous Session (Session 17)

**1. Fixed Network IP Detection for Mobile Testing**

The `getAppBaseUrl()` and related network functions were only using network IP when `NODE_ENV === "development"`, but in many runtime contexts (like API route handlers), `NODE_ENV` is `undefined`. Changed the condition to `NODE_ENV !== "production"` so network IP is used whenever not explicitly in production.

**Changes:**
- `getAppBaseUrl()` - now uses network IP when NODE_ENV is not "production"
- `getDocuSealUrl()` - same fix
- `getTrustedOrigins()` - same fix

**Root cause:** When calling these functions from API routes, NODE_ENV was undefined, causing fallback to localhost.

**2. Added Signed PDF Display to Provider Submissions**

Providers can now see PDF signing status in the submissions list and download signed PDFs from the submission detail view.

**Changes:**
- Added `pdfSigning` to submission list and detail API responses
- Added "PDF" column to submissions table showing Signed/Pending/— status
- Added "PDF Document" card in submission detail modal with signed status and download link

**Files Modified:**
```
app/src/lib/network.ts                                    # Fixed NODE_ENV check
app/src/app/api/provider/submissions/route.ts             # Added pdfSigning to response
app/src/app/api/provider/submissions/[id]/route.ts        # Added pdfSigning to response
app/src/app/(provider)/provider/submissions/page.tsx      # Added PDF column and detail card
```

### DocuSeal Integration Status

#### Provider Portal
- PDF Document tab in form builder with:
  - Enable/disable toggle
  - Link to open DocuSeal admin panel
  - Manual Template ID input
  - Field mapping interface (when form has fields)
- Note: Providers must create templates in DocuSeal admin first

#### Patient Portal
- Redirect-based signing flow:
  1. Patient submits form
  2. If PDF enabled, shows "Sign Document Now" button
  3. Redirects to DocuSeal's hosted signing page
  4. After signing, redirects back to Chkin with signed=true
  5. Shows success message

#### Infrastructure
- Self-hosted DocuSeal via Docker (free version)
- Single platform account for all providers
- Webhook handler for completion events (backup)
- Callback route for redirect return (primary)

### What's Done (Cumulative)

- Admin console with responsive layout
- Provider management (list, detail, approve, reject)
- User management (list, detail, edit, session revoke)
- Field Library (291 fields, APIs, admin UI)
- Audit Log viewer (admin console)
- Provider Portal with Form Builder
- Google Places Address Autocomplete integration
- QR Code System (generation, management, scan tracking)
- Public Form Submission (via QR short codes)
- Submissions Management (list, view, status updates)
- Phone Input Component (country codes, formatting, validation)
- Referral Doctor Input (with saved doctors, specialty selection)
- Quick Start Template (form builder pre-population)
- Test Data Generator (dev-only form auto-fill)
- Registration Pre-fill (from anonymous form submission)
- Patient Data Vault UI (wallet-style cards, progress ring, sheet editing)
- CategoryMeta model (dynamic category configuration)
- Anonymous submission linking (auto-sync on login/registration)
- Profile saving (from vault sheet edit mode)
- Time-Bound Consent (complete POPIA compliance)
- **DocuSeal Integration** (PDF form population and e-signatures):
  - Self-hosted DocuSeal via Docker
  - Redirect-based signing (free version compatible)
  - Provider PDF template configuration via admin panel
  - Field mapping (Chkin → DocuSeal)
  - Patient signature flow with redirect
  - Webhook + callback handling for completion

### What's Next (Priority Order)

1. Password reset flow
2. Provider self-edit pages
3. Email template improvements
4. Test DocuSeal end-to-end flow

### Dev Login Credentials

| Button | Email | Password |
|--------|-------|----------|
| Admin | admin@chkin.co.za | Admin@Chkin123! |
| Provider | info@winelandskneeclinic.co.za | femur-MANURE7switches |
| User | john.smith@example.com | examined6cosmos@STUDYING |

### Commands

**One-command local startup (recommended):**
```powershell
cd app
.\start-local.ps1
```
Or via npm: `npm run start:local`

**DocuSeal (separate terminal):**
```bash
cd app && docker-compose up docuseal
```

**Manual commands:**
```bash
cd app && npm run dev      # Start dev server
cd app && npm run build    # Build for production
cd app && npm run lint     # Run ESLint
npx tsx prisma/seed-fields.ts       # Seed field definitions
npx tsx prisma/seed-categories.ts   # Seed category metadata
npx tsx prisma/create-admin.ts      # Create admin user
```

### DocuSeal Setup Guide

1. **Start DocuSeal:** `docker-compose up docuseal -d`
2. **Access admin:** http://127.0.0.1:3001 (use 127.0.0.1, not localhost on Windows)
3. **Create account** on first visit
4. **Get API key:** Settings → API → Copy key
5. **Add to .env:**
   ```
   DOCUSEAL_URL="http://127.0.0.1:3001"
   DOCUSEAL_API_KEY="your-api-key-here"
   ```
6. **Create template:** Upload PDF, add fields, save
7. **Note Template ID:** Shown in URL after saving (e.g., /templates/1)
8. **In Chkin:** Enter Template ID in form builder PDF tab

### Known Limitations

- Password reset not yet implemented
- Email deliverability uses test domain
- DocuSeal requires separate Docker container to be running
- Embedded signing requires DocuSeal Pro (currently using redirect-based)

### Tech Debt & Follow-up

- npm audit high severity vulnerability (tracked in TODO.md)
- Middleware convention warning in Next.js 16
- 12 pre-existing ESLint warnings (unused vars, img elements)
