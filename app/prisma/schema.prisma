// Chkin Database Schema
// Dynamic fields are stored as JSONB in form templates and submissions
// Better Auth provides authentication with multi-tenancy via organizations

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// BETTER AUTH CORE MODELS
// =============================================================================

// Core user table - central authentication entity
model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  isSystemAdmin Boolean   @default(false)  // Platform administrator flag
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  sessions                    Session[]
  accounts                    Account[]
  members                     Member[]
  invitations                 Invitation[]
  teamMembers                 TeamMember[]
  pendingProviderRegistration PendingProviderRegistration?
  auditLogs                   AuditLog[]
  patientProfile              PatientProfile?

  @@map("user")
}

// Session management for active user sessions
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Organization context fields
  activeOrganizationId String?
  activeTeamId         String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

// Account providers (OAuth, credentials, etc.)
model Account {
  id                     String    @id @default(cuid())
  userId                 String
  accountId              String
  providerId             String
  accessToken            String?
  refreshToken           String?
  accessTokenExpiresAt   DateTime?
  refreshTokenExpiresAt  DateTime?
  scope                  String?
  idToken                String?
  password               String?   // Hashed password for email/password auth
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("account")
}

// Email verification and password reset tokens
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@map("verification")
}

// =============================================================================
// ORGANIZATION PLUGIN MODELS (Multi-tenancy)
// =============================================================================

// Organizations represent practices in Chkin
model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  metadata  String?  // JSONB field for additional practice info
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Provider registration fields
  status          String   @default("pending")  // pending, approved, rejected
  practiceNumber  String?                       // Optional practice registration number
  phone           String?
  industryType    String?                       // General Practice, Specialist, Dental, etc.
  website         String?
  rejectionReason String?                       // Reason if rejected by admin
  approvedAt      DateTime?
  approvedBy      String?                       // userId of admin who approved

  // Address fields (aligned with AddressComponents interface)
  complexName     String?                       // Building/estate/complex name
  unitNumber      String?                       // Unit/apartment/suite number
  streetAddress   String?                       // Street number + street name
  suburb          String?                       // Sublocality
  city            String?
  province        String?                       // Administrative area level 1
  postalCode      String?
  country         String?  @default("South Africa")
  lat             Float?                        // GPS latitude
  lng             Float?                        // GPS longitude

  // Legacy field - kept for backwards compatibility during migration
  address         String?                       // @deprecated Use streetAddress instead

  // Relationships
  members       Member[]
  invitations   Invitation[]
  teams         Team[]
  roles         OrganizationRole[]
  formTemplates FormTemplate[]
  auditLogs     AuditLog[]

  @@map("organization")
}

// Pending provider registrations - stores form data until email is verified
model PendingProviderRegistration {
  id              String   @id @default(cuid())
  userId          String   @unique // One pending registration per user
  practiceName    String
  practiceNumber  String?
  phone           String
  industryType    String
  website         String?
  // Address fields (aligned with Organization model)
  complexName     String?
  unitNumber      String?
  streetAddress   String?
  suburb          String?
  city            String
  province        String?
  postalCode      String
  country         String?  @default("South Africa")
  // Legacy field for backwards compatibility
  address         String?
  createdAt       DateTime @default(now())
  expiresAt       DateTime @default(dbgenerated("NOW() + interval '24 hours'")) // Expire after 24 hours

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pending_provider_registration")
}

// Members link users to organizations with roles
model Member {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           String   // e.g., "admin", "provider", "staff"
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("member")
}

// Invitations for adding new members to organizations
model Invitation {
  id             String   @id @default(cuid())
  email          String
  inviterId      String
  organizationId String
  role           String
  status         String   @default("pending") // pending, accepted, rejected, expired
  teamId         String?
  createdAt      DateTime @default(now())
  expiresAt      DateTime
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter      User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)
  team         Team?        @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@map("invitation")
}

// Teams within organizations (optional sub-grouping)
model Team {
  id             String   @id @default(cuid())
  name           String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      TeamMember[]
  invitations  Invitation[]

  @@map("team")
}

// Team membership
model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_member")
}

// Custom roles with dynamic permissions per organization
model OrganizationRole {
  id             String   @id @default(cuid())
  organizationId String
  role           String
  permissions    String   // JSON array of permission strings
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, role])
  @@map("organization_role")
}

// =============================================================================
// FIELD LIBRARY MODELS (Dynamic Form Fields)
// =============================================================================

// Global field definitions managed by platform admin
// These are the "standard field library" that providers pick from
model FieldDefinition {
  id          String   @id @default(cuid())
  name        String   // Internal canonical name (e.g., "firstName", "dateOfBirth")
  label       String   // Default display label (e.g., "First Name")
  description String   // Clear description of what the field means and should be used for
  fieldType   String   // text, email, phone, date, datetime, select, multiselect, checkbox, radio, textarea, number, file, signature, country, currency

  // Category for organizing fields in the library
  // Core: personal, identity, contact, address, emergency, responsible, preferences
  // Industry: medical, insurance, education, employment, events, membership, legal, financial, consent
  category    String

  // Field configuration (stored as JSON)
  // For select/multiselect/radio: { options: [{ value: "male", label: "Male" }, ...] }
  // For text: { minLength: 1, maxLength: 100, pattern: "regex", placeholder: "..." }
  // For number: { min: 0, max: 200, step: 1, decimalPlaces: 0 }
  // For file: { allowedTypes: ["image/*", "application/pdf"], maxSizeMB: 10 }
  // For country: { defaultCountry: "ZA" }
  // For currency: { currencyCode: "ZAR", decimalPlaces: 2 }
  config      String?  // JSON configuration

  // Validation rules (stored as JSON)
  // { required: false, customMessage: "Please enter valid email" }
  validation  String?  // JSON validation rules

  // Display order within category
  sortOrder   Int      @default(0)

  // Whether this field is available for use
  isActive    Boolean  @default(true)

  // POPIA compliance flags
  specialPersonalInfo  Boolean  @default(false)  // POPIA special personal info (race, religion, health, biometrics, etc.)
  requiresExplicitConsent Boolean @default(false)  // Requires separate explicit consent

  // Audit fields
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  // Admin who created this field

  // Relationships
  formFields  FormField[]

  @@unique([name])
  @@index([category, isActive])
  @@index([specialPersonalInfo])
  @@map("field_definition")
}

// Form templates created by providers
model FormTemplate {
  id             String   @id @default(cuid())
  organizationId String
  title          String   // Form display name
  description    String?  // Form purpose/description

  // Consent configuration
  consentClause  String?  // Consent text (can be long)

  // Form status
  isActive       Boolean  @default(true)
  version        Int      @default(1)

  // Audit fields
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String?  // User who created this form

  // Relationships
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fields         FormField[]
  qrCodes        QRCode[]
  submissions    Submission[]

  @@index([organizationId, isActive])
  @@map("form_template")
}

// Fields used in a specific form (junction table with customization)
model FormField {
  id                String   @id @default(cuid())
  formTemplateId    String
  fieldDefinitionId String

  // Field customization for this form
  labelOverride     String?  // Override the default label
  helpText          String?  // Form-specific help text
  isRequired        Boolean  @default(false)

  // Display configuration
  sortOrder         Int      @default(0)
  section           String?  // Group fields into sections (e.g., "Patient Details")
  columnSpan        Int      @default(8)  // Column span out of 8 (8 = full width)

  // Visibility rules (JSON)
  // { showWhen: { field: "hasMedicalAid", equals: true } }
  visibilityRules   String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  formTemplate      FormTemplate    @relation(fields: [formTemplateId], references: [id], onDelete: Cascade)
  fieldDefinition   FieldDefinition @relation(fields: [fieldDefinitionId], references: [id], onDelete: Restrict)

  @@unique([formTemplateId, fieldDefinitionId])
  @@index([formTemplateId, sortOrder])
  @@map("form_field")
}

// QR codes linked to forms
model QRCode {
  id             String   @id @default(cuid())
  formTemplateId String

  // QR code data
  shortCode      String   @unique // Short URL code (e.g., "abc123")
  label          String?  // Optional label (e.g., "Reception Desk")

  // Scan tracking
  scanCount      Int      @default(0)
  lastScannedAt  DateTime?

  // Status
  isActive       Boolean  @default(true)

  // Audit fields
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String?

  // Relationships
  formTemplate   FormTemplate @relation(fields: [formTemplateId], references: [id], onDelete: Cascade)

  @@index([shortCode])
  @@map("qr_code")
}

// Form submissions from patients
model Submission {
  id             String   @id @default(cuid())
  formTemplateId String
  organizationId String
  userId         String?  // Null for anonymous/guest submissions

  // Submission data (JSON with field values)
  data           String   // JSON payload of form values

  // Consent tracking
  consentToken   String?  @unique
  consentGiven   Boolean  @default(false)
  consentAt      DateTime?

  // Consent withdrawal (POPIA right to withdraw consent)
  consentWithdrawnAt DateTime?  // When consent was withdrawn
  withdrawalReason   String?    // Optional reason for withdrawal

  // Status
  status         String   @default("pending") // pending, completed, expired

  // Source tracking
  source         String   @default("web") // web, app
  ipAddress      String?
  userAgent      String?

  // Anonymous user tracking - allows claiming submissions after registration
  anonymousToken String?  @unique  // Token for anonymous users to claim submission
  claimedAt      DateTime?         // When submission was claimed by registered user

  // Audit fields
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relationships
  formTemplate   FormTemplate @relation(fields: [formTemplateId], references: [id], onDelete: Restrict)

  @@index([organizationId, createdAt])
  @@index([formTemplateId, status])
  @@index([userId])
  @@index([anonymousToken])
  @@map("submission")
}

// =============================================================================
// AUDIT LOG MODEL (POPIA Compliance)
// =============================================================================

// Audit trail for all sensitive data access and modifications
model AuditLog {
  id             String        @id @default(cuid())
  userId         String?       // Who performed the action
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organizationId String?       // Which practice
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  action         String        // e.g., "VIEW_PATIENT_DATA", "UPDATE_CONSENT"
  resourceType   String        // e.g., "Patient", "Consent", "Form"
  resourceId     String?       // ID of the affected resource
  ipAddress      String?
  userAgent      String?
  metadata       String?       // JSON with additional context
  createdAt      DateTime      @default(now())

  @@index([userId, createdAt])
  @@index([organizationId, createdAt])
  @@index([resourceType, resourceId])
  @@index([action])
  @@map("audit_log")
}

// =============================================================================
// PATIENT PROFILE MODEL
// =============================================================================

// Patient profile - stores canonical patient data that maps to field library
// Field names in the data JSON match FieldDefinition.name for automatic form pre-fill
model PatientProfile {
  id        String   @id @default(cuid())
  userId    String   @unique // One profile per user

  // All profile data stored as JSONB
  // Keys match FieldDefinition.name (e.g., "firstName", "dateOfBirth", "homeStreetAddress")
  // This enables automatic form pre-population and profile sync
  data      String   // JSON object with field values

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("patient_profile")
}

// =============================================================================
// CATEGORY METADATA MODEL
// =============================================================================

// Category metadata for organizing field definitions in the patient vault
// Categories are displayed as cards in the wallet-style UI
model CategoryMeta {
  id            String   @id @default(cuid())
  name          String   @unique  // Internal name: "personal", "medical", etc.
  label         String             // Display label: "Personal Details"
  description   String?            // Category description: "Your basic information"
  icon          String             // Heroicons name: "user", "heart", "shield"
  sortOrder     Int      @default(0)  // Display order in vault UI
  color         String?            // Tailwind color class: "teal", "red", "blue"
  isProtected   Boolean  @default(false)  // Requires re-auth to view sensitive data
  isActive      Boolean  @default(true)   // Whether category is shown in vault
  previewFields String[]           // Field names for card summary preview

  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("category_meta")
}
