// Chkin Database Schema
// Dynamic fields are stored as JSONB in form templates and submissions
// Better Auth provides authentication with multi-tenancy via organizations

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// BETTER AUTH CORE MODELS
// =============================================================================

// Core user table - central authentication entity
model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  isSystemAdmin Boolean   @default(false)  // Platform administrator flag
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  sessions                    Session[]
  accounts                    Account[]
  members                     Member[]
  invitations                 Invitation[]
  teamMembers                 TeamMember[]
  pendingProviderRegistration PendingProviderRegistration?

  @@map("user")
}

// Session management for active user sessions
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Organization context fields
  activeOrganizationId String?
  activeTeamId         String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

// Account providers (OAuth, credentials, etc.)
model Account {
  id                     String    @id @default(cuid())
  userId                 String
  accountId              String
  providerId             String
  accessToken            String?
  refreshToken           String?
  accessTokenExpiresAt   DateTime?
  refreshTokenExpiresAt  DateTime?
  scope                  String?
  idToken                String?
  password               String?   // Hashed password for email/password auth
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("account")
}

// Email verification and password reset tokens
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@map("verification")
}

// =============================================================================
// ORGANIZATION PLUGIN MODELS (Multi-tenancy)
// =============================================================================

// Organizations represent practices in Chkin
model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  metadata  String?  // JSONB field for additional practice info
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Provider registration fields
  status          String   @default("pending")  // pending, approved, rejected
  practiceNumber  String?                       // Optional practice registration number
  phone           String?
  industryType    String?                       // General Practice, Specialist, Dental, etc.
  address         String?
  city            String?
  postalCode      String?
  website         String?
  rejectionReason String?                       // Reason if rejected by admin
  approvedAt      DateTime?
  approvedBy      String?                       // userId of admin who approved

  // Relationships
  members     Member[]
  invitations Invitation[]
  teams       Team[]
  roles       OrganizationRole[]

  @@map("organization")
}

// Pending provider registrations - stores form data until email is verified
model PendingProviderRegistration {
  id              String   @id @default(cuid())
  userId          String   @unique // One pending registration per user
  practiceName    String
  practiceNumber  String?
  phone           String
  industryType    String
  address         String
  city            String
  postalCode      String
  website         String?
  createdAt       DateTime @default(now())
  expiresAt       DateTime @default(dbgenerated("NOW() + interval '24 hours'")) // Expire after 24 hours

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("pending_provider_registration")
}

// Members link users to organizations with roles
model Member {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           String   // e.g., "admin", "provider", "staff"
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("member")
}

// Invitations for adding new members to organizations
model Invitation {
  id             String   @id @default(cuid())
  email          String
  inviterId      String
  organizationId String
  role           String
  status         String   @default("pending") // pending, accepted, rejected, expired
  teamId         String?
  createdAt      DateTime @default(now())
  expiresAt      DateTime
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter      User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)
  team         Team?        @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@map("invitation")
}

// Teams within organizations (optional sub-grouping)
model Team {
  id             String   @id @default(cuid())
  name           String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      TeamMember[]
  invitations  Invitation[]

  @@map("team")
}

// Team membership
model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_member")
}

// Custom roles with dynamic permissions per organization
model OrganizationRole {
  id             String   @id @default(cuid())
  organizationId String
  role           String
  permissions    String   // JSON array of permission strings
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, role])
  @@map("organization_role")
}

// =============================================================================
// AUDIT LOG MODEL (POPIA Compliance)
// =============================================================================

// Audit trail for all sensitive data access and modifications
model AuditLog {
  id             String   @id @default(cuid())
  userId         String?  // Who performed the action
  organizationId String?  // Which practice
  action         String   // e.g., "VIEW_PATIENT_DATA", "UPDATE_CONSENT"
  resourceType   String   // e.g., "Patient", "Consent", "Form"
  resourceId     String?  // ID of the affected resource
  ipAddress      String?
  userAgent      String?
  metadata       String?  // JSON with additional context
  createdAt      DateTime @default(now())

  @@index([userId, createdAt])
  @@index([organizationId, createdAt])
  @@index([resourceType, resourceId])
  @@map("audit_log")
}
